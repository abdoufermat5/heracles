# -*- mode: ruby -*-
# vi: set ft=ruby :
#
# Heracles Demo Environment
# =========================
# Multi-VM environment for testing SSH, Sudo, POSIX, DNS, DHCP, Mail and Systems plugins
# with real LDAP authentication via SSSD.
#
# Prerequisites:
#   - VirtualBox installed
#   - Vagrant installed
#   - Heracles infrastructure running (make dev-infra)
#
# Usage:
#   cd demo
#   vagrant up
#   vagrant ssh server1      # Test as server
#   vagrant ssh workstation1 # Test as workstation
#   vagrant ssh ns1          # DNS server
#   vagrant ssh mail1        # Mail server
#
# Configuration:
#   All settings are in config/demo.conf
#

# Load configuration from demo.conf
require_relative 'config/vagrant_helper'

Vagrant.configure("2") do |config|
  # Common configuration for all VMs
  config.vm.box = DEMO["VAGRANT_BOX"]
  config.vm.box_version = DEMO["VAGRANT_BOX_VERSION"]
  
  # Synced folders
  config.vm.synced_folder ".", "/vagrant", disabled: true
  config.vm.synced_folder "./provision", "/vagrant/provision"
  config.vm.synced_folder "./config", "/vagrant/config"

  # ==========================================================================
  # VM 0: ns1 - DNS Server (BIND9 with LDAP sync)
  # ==========================================================================
  config.vm.define "ns1" do |dns|
    dns.vm.hostname = "ns1.#{DEMO['DOMAIN']}"
    dns.vm.network "private_network", ip: DEMO["NS1_IP"]
    
    dns.vm.provider "virtualbox" do |vb|
      vb.name = "heracles-ns1"
      vb.memory = DEMO["VM_MEMORY_NS1"]
      vb.cpus = DEMO["VM_CPUS"]
      vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    end

    dns.vm.provider "libvirt" do |lv|
      lv.memory = DEMO["VM_MEMORY_NS1"]
      lv.cpus = DEMO["VM_CPUS"]
    end
    
    # Initial setup - copy config and setup hosts
    dns.vm.provision "shell", inline: <<-SHELL
      echo "==> Setting up ns1 DNS server for Heracles..."
      echo "#{DEMO['HOST_IP']} ldap.#{DEMO['DOMAIN']}" >> /etc/hosts
    SHELL
    
    dns.vm.provision "shell", path: "provision/setup-bind.sh"
  end

  # ==========================================================================
  # VM 1: dhcp1 - DHCP Server (ISC DHCP with LDAP sync)
  # ==========================================================================
  config.vm.define "dhcp1" do |dhcp|
    dhcp.vm.hostname = "dhcp1.#{DEMO['DOMAIN']}"
    dhcp.vm.network "private_network", ip: DEMO["DHCP1_IP"]
    
    dhcp.vm.provider "virtualbox" do |vb|
      vb.name = "heracles-dhcp1"
      vb.memory = DEMO["VM_MEMORY_DHCP1"]
      vb.cpus = DEMO["VM_CPUS"]
      vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    end

    dhcp.vm.provider "libvirt" do |lv|
      lv.memory = DEMO["VM_MEMORY_DHCP1"]
      lv.cpus = DEMO["VM_CPUS"]
    end
    
    # Initial setup - copy config and setup hosts
    dhcp.vm.provision "shell", inline: <<-SHELL
      echo "==> Setting up dhcp1 DHCP server for Heracles..."
      echo "#{DEMO['HOST_IP']} ldap.#{DEMO['DOMAIN']}" >> /etc/hosts
      echo "#{DEMO['NS1_IP']} ns1.#{DEMO['DOMAIN']}" >> /etc/hosts
      
      # Configure DNS resolver to use ns1
      if systemctl is-active --quiet systemd-resolved 2>/dev/null; then
        systemctl disable --now systemd-resolved
        rm -f /etc/resolv.conf
      fi
      
      cat > /etc/resolv.conf << EOF
nameserver #{DEMO['NS1_IP']}
nameserver #{DEMO['DNS_FORWARDER']}
search #{DEMO['DOMAIN']}
EOF
      chattr +i /etc/resolv.conf 2>/dev/null || true
    SHELL
    
    dhcp.vm.provision "shell", path: "provision/setup-dhcp.sh"
  end

  # ==========================================================================
  # VM 2: mail1 - Mail Server (Postfix + Dovecot with direct LDAP auth)
  # ==========================================================================
  config.vm.define "mail1" do |mail|
    mail.vm.hostname = "mail1.#{DEMO['DOMAIN']}"
    mail.vm.network "private_network", ip: DEMO["MAIL1_IP"], mac: DEMO["MAIL1_MAC"].tr(':', '')
    
    mail.vm.provider "virtualbox" do |vb|
      vb.name = "heracles-mail1"
      vb.memory = DEMO["VM_MEMORY_MAIL1"]
      vb.cpus = DEMO["VM_CPUS"]
      vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    end

    mail.vm.provider "libvirt" do |lv|
      lv.memory = DEMO["VM_MEMORY_MAIL1"]
      lv.cpus = DEMO["VM_CPUS"]
    end
    
    # Initial setup - copy config and setup hosts + DNS
    mail.vm.provision "shell", inline: <<-SHELL
      echo "==> Setting up mail1 Mail server for Heracles..."
      echo "#{DEMO['HOST_IP']} ldap.#{DEMO['DOMAIN']}" >> /etc/hosts
      echo "#{DEMO['NS1_IP']} ns1.#{DEMO['DOMAIN']}" >> /etc/hosts
      echo "#{DEMO['DHCP1_IP']} dhcp1.#{DEMO['DOMAIN']}" >> /etc/hosts
      
      # Configure DNS resolver to use ns1
      if systemctl is-active --quiet systemd-resolved 2>/dev/null; then
        systemctl disable --now systemd-resolved
        rm -f /etc/resolv.conf
      fi
      
      cat > /etc/resolv.conf << EOF
nameserver #{DEMO['NS1_IP']}
nameserver #{DEMO['DNS_FORWARDER']}
search #{DEMO['DOMAIN']}
EOF
      chattr +i /etc/resolv.conf 2>/dev/null || true
    SHELL
    
    # Postfix + Dovecot mail server (authenticates directly against LDAP)
    mail.vm.provision "shell", path: "provision/setup-mail.sh"
  end

  # ==========================================================================
  # VM 3: server1 - Simulates a server system
  # ==========================================================================
  config.vm.define "server1", primary: true do |server|
    server.vm.hostname = "server1.#{DEMO['DOMAIN']}"
    server.vm.network "private_network", ip: DEMO["SERVER1_IP"]
    
    server.vm.provider "virtualbox" do |vb|
      vb.name = "heracles-server1"
      vb.memory = DEMO["VM_MEMORY_SERVER"]
      vb.cpus = DEMO["VM_CPUS"]
      vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    end

    server.vm.provider "libvirt" do |lv|
      lv.memory = DEMO["VM_MEMORY_SERVER"]
      lv.cpus = DEMO["VM_CPUS"]
    end
    
    # Network and DNS setup
    server.vm.provision "shell", inline: <<-SHELL
      echo "==> Setting up server1 for Heracles testing..."
      source /vagrant/config/demo.conf
      
      # Add hosts entries
      echo "#{DEMO['HOST_IP']} ldap.#{DEMO['DOMAIN']}" >> /etc/hosts
      echo "#{DEMO['NS1_IP']} ns1.#{DEMO['DOMAIN']}" >> /etc/hosts
      echo "#{DEMO['DHCP1_IP']} dhcp1.#{DEMO['DOMAIN']}" >> /etc/hosts
      
      # Configure persistent DNS resolver
      if systemctl is-active --quiet systemd-resolved 2>/dev/null; then
        systemctl disable --now systemd-resolved
        rm -f /etc/resolv.conf
      fi
      
      cat > /etc/resolv.conf << EOF
nameserver #{DEMO['NS1_IP']}
nameserver #{DEMO['DNS_FORWARDER']}
search #{DEMO['DOMAIN']}
EOF
      chattr +i /etc/resolv.conf 2>/dev/null || true
    SHELL
    
    server.vm.provision "shell", path: "provision/setup-sssd.sh", args: ["server1"]
    server.vm.provision "shell", path: "provision/setup-ssh.sh"
    server.vm.provision "shell", path: "provision/setup-sudo.sh"
  end

  # ==========================================================================
  # VM 4: workstation1 - Simulates a workstation system
  # ==========================================================================
  config.vm.define "workstation1" do |ws|
    ws.vm.hostname = "workstation1.#{DEMO['DOMAIN']}"
    ws.vm.network "private_network", ip: DEMO["WORKSTATION1_IP"]
    
    ws.vm.provider "virtualbox" do |vb|
      vb.name = "heracles-workstation1"
      vb.memory = DEMO["VM_MEMORY_WORKSTATION"]
      vb.cpus = DEMO["VM_CPUS"]
      vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    end

    ws.vm.provider "libvirt" do |lv|
      lv.memory = DEMO["VM_MEMORY_WORKSTATION"]
      lv.cpus = DEMO["VM_CPUS"]
    end
    
    # Network and DNS setup
    ws.vm.provision "shell", inline: <<-SHELL
      echo "==> Setting up workstation1 for Heracles testing..."
      source /vagrant/config/demo.conf
      
      # Add hosts entries
      echo "#{DEMO['HOST_IP']} ldap.#{DEMO['DOMAIN']}" >> /etc/hosts
      echo "#{DEMO['NS1_IP']} ns1.#{DEMO['DOMAIN']}" >> /etc/hosts
      echo "#{DEMO['DHCP1_IP']} dhcp1.#{DEMO['DOMAIN']}" >> /etc/hosts
      
      # Configure persistent DNS resolver
      if systemctl is-active --quiet systemd-resolved 2>/dev/null; then
        systemctl disable --now systemd-resolved
        rm -f /etc/resolv.conf
      fi
      
      cat > /etc/resolv.conf << EOF
nameserver #{DEMO['NS1_IP']}
nameserver #{DEMO['DNS_FORWARDER']}
search #{DEMO['DOMAIN']}
EOF
      chattr +i /etc/resolv.conf 2>/dev/null || true
    SHELL
    
    ws.vm.provision "shell", path: "provision/setup-sssd.sh", args: ["workstation1"]
    ws.vm.provision "shell", path: "provision/setup-ssh.sh"
    ws.vm.provision "shell", path: "provision/setup-sudo.sh"
  end
end
