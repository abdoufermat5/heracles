services:
  # ===========================================
  # OpenLDAP Server (Heracles compatible)
  # ===========================================
  ldap:
    image: osixia/openldap:1.5.0
    container_name: heracles-ldap
    hostname: ldap.heracles.local
    environment:
      LDAP_ORGANISATION: "${LDAP_ORGANISATION}"
      LDAP_DOMAIN: "${LDAP_DOMAIN}"
      LDAP_BASE_DN: "${LDAP_BASE_DN}"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      LDAP_CONFIG_PASSWORD: "${LDAP_CONFIG_PASSWORD}"
      LDAP_TLS: "true"
      LDAP_TLS_CRT_FILENAME: "ldap.crt"
      LDAP_TLS_KEY_FILENAME: "ldap.key"
      LDAP_TLS_CA_CRT_FILENAME: "ca.crt"
      LDAP_TLS_VERIFY_CLIENT: "never"
      LDAP_REPLICATION: "false"
      LDAP_REMOVE_CONFIG_AFTER_SETUP: "false"
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      - ./pki/dev/ldap/ldap.heracles.local.crt:/container/service/slapd/assets/certs/ldap.crt
      - ./pki/dev/ldap/ldap.heracles.local.key:/container/service/slapd/assets/certs/ldap.key
      - ./pki/dev/ca/heracles-dev-ca.crt:/container/service/slapd/assets/certs/ca.crt
    ports:
      - "${LDAP_PORT:-389}:389"
      - "${LDAPS_PORT:-636}:636"
    networks:
      - heracles-net
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost", "-b", "${LDAP_BASE_DN}", "-D", "${LDAP_BIND_DN}", "-w", "${LDAP_ADMIN_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # phpLDAPadmin for LDAP management
  phpldapadmin:
    image: osixia/phpldapadmin:0.9.0
    container_name: heracles-phpldapadmin
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: "ldap"
      PHPLDAPADMIN_HTTPS: "false"
    ports:
      - "${PHPLDAPADMIN_PORT:-8080}:80"
    depends_on:
      - ldap
    networks:
      - heracles-net

  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    image: postgres:15-alpine
    container_name: heracles-postgres
    environment:
      POSTGRES_DB: "${POSTGRES_DB}"
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - heracles-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Redis Cache/Sessions
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: heracles-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - heracles-net
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Heracles API (FastAPI) - Development
  # ===========================================
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    container_name: heracles-api
    environment:
      # LDAP
      LDAP_URI: "ldaps://ldap.heracles.local:636"
      LDAP_BASE_DN: "${LDAP_BASE_DN}"
      LDAP_BIND_DN: "${LDAP_BIND_DN}"
      LDAP_BIND_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      LDAP_USE_TLS: "false"
      LDAP_POOL_SIZE: "${LDAP_POOL_SIZE}"
      # PostgreSQL
      DATABASE_URL: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}"
      # Redis
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379/0"
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      # API
      API_HOST: "${API_HOST}"
      API_PORT: "${API_PORT}"
      DEBUG: "${DEBUG}"
      SECRET_KEY: "${SECRET_KEY}"
      # Logging
      LOG_LEVEL: "${LOG_LEVEL}"
      # TLS trust (LDAPS)
      SSL_CERT_FILE: "/etc/ssl/certs/heracles-dev-ca.crt"
    volumes:
      - ./heracles-api:/app
      - ./heracles-core:/heracles-core:ro
      - ./heracles_plugins:/heracles_plugins
      - ./pki/dev/ca/heracles-dev-ca.crt:/etc/ssl/certs/heracles-dev-ca.crt:ro
    depends_on:
      ldap:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - heracles-net
    command: ["uvicorn", "heracles_api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    profiles:
      - full

  # ===========================================
  # Heracles UI (React) - Development
  # ===========================================
  ui:
    build:
      context: .
      dockerfile: docker/ui/Dockerfile
      target: builder
    container_name: heracles-ui
    environment:
      VITE_API_BASE_PREFIX: "${VITE_API_BASE_PREFIX}"
    volumes:
      - ./heracles-ui:/app
      - /app/node_modules
    depends_on:
      - api
    networks:
      - heracles-net
    command: ["bun", "run", "dev", "--host", "0.0.0.0", "--port", "3000"]
    profiles:
      - full

  # ===========================================
  # TLS Reverse Proxy (Nginx)
  # ===========================================
  proxy:
    image: nginx:alpine
    container_name: heracles-proxy
    volumes:
      - ./docker/proxy/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./pki/dev/server/heracles.local.crt:/etc/nginx/certs/heracles.local.crt:ro
      - ./pki/dev/server/heracles.local.key:/etc/nginx/certs/heracles.local.key:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - ui
      - api
    networks:
      - heracles-net
    profiles:
      - full

# ===========================================
# Networks
# ===========================================
networks:
  heracles-net:
    driver: bridge

# ===========================================
# Volumes
# ===========================================
volumes:
  ldap_data:
  ldap_config:
  postgres_data:
  redis_data:
