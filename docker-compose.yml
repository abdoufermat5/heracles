# Docker Compose for Heracles Development
# ===========================================
# This setup provides all required services for local development
# 
# Environment variables are loaded from .env file
# Copy .env.example to .env and adjust values for your environment

services:
  # ===========================================
  # OpenLDAP Server (FusionDirectory compatible)
  # ===========================================
  ldap:
    image: osixia/openldap:1.5.0
    container_name: heracles-ldap
    hostname: ldap.heracles.local
    environment:
      LDAP_ORGANISATION: "${LDAP_ORGANISATION}"
      LDAP_DOMAIN: "${LDAP_DOMAIN}"
      LDAP_BASE_DN: "${LDAP_BASE_DN}"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      LDAP_CONFIG_PASSWORD: "${LDAP_CONFIG_PASSWORD}"
      LDAP_TLS: "false"
      LDAP_TLS_VERIFY_CLIENT: "never"
      LDAP_REPLICATION: "false"
      LDAP_REMOVE_CONFIG_AFTER_SETUP: "false"
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
      # Note: Custom schemas are loaded manually via: make ldap-schemas
      # This avoids permission issues with volume mounts
      # Schema files are in: ./docker/ldap/schemas/
    ports:
      - "${LDAP_PORT:-389}:389"
      - "${LDAPS_PORT:-636}:636"
    networks:
      - heracles-net
    healthcheck:
      test: ["CMD", "ldapsearch", "-x", "-H", "ldap://localhost", "-b", "${LDAP_BASE_DN}", "-D", "${LDAP_BIND_DN}", "-w", "${LDAP_ADMIN_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # phpLDAPadmin for LDAP management
  phpldapadmin:
    image: osixia/phpldapadmin:0.9.0
    container_name: heracles-phpldapadmin
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: "ldap"
      PHPLDAPADMIN_HTTPS: "false"
    ports:
      - "${PHPLDAPADMIN_PORT:-8080}:80"
    depends_on:
      - ldap
    networks:
      - heracles-net

  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    image: postgres:15-alpine
    container_name: heracles-postgres
    environment:
      POSTGRES_DB: "${POSTGRES_DB}"
      POSTGRES_USER: "${POSTGRES_USER}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - heracles-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Redis Cache/Sessions
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: heracles-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - heracles-net
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Heracles API (FastAPI) - Development
  # ===========================================
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    container_name: heracles-api
    environment:
      # LDAP
      LDAP_URI: "ldap://ldap:389"
      LDAP_BASE_DN: "${LDAP_BASE_DN}"
      LDAP_BIND_DN: "${LDAP_BIND_DN}"
      LDAP_BIND_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      LDAP_USE_TLS: "${LDAP_USE_TLS}"
      LDAP_POOL_SIZE: "${LDAP_POOL_SIZE}"
      # PostgreSQL
      DATABASE_URL: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}"
      # Redis
      REDIS_URL: "redis://:${REDIS_PASSWORD}@redis:6379/0"
      # API
      API_HOST: "${API_HOST}"
      API_PORT: "${API_PORT}"
      DEBUG: "${DEBUG}"
      SECRET_KEY: "${SECRET_KEY}"
      # Logging
      LOG_LEVEL: "${LOG_LEVEL}"
    volumes:
      - ./heracles-api:/app
      - ./heracles-core:/heracles-core:ro
      - ./heracles_plugins:/heracles_plugins
    ports:
      - "${API_PORT:-8000}:8000"
    depends_on:
      ldap:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - heracles-net
    command: ["uvicorn", "heracles_api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    profiles:
      - full

  # ===========================================
  # Heracles UI (React) - Development
  # ===========================================
  ui:
    build:
      context: ./heracles-ui
      dockerfile: Dockerfile
      target: builder
    container_name: heracles-ui
    environment:
      VITE_API_BASE_URL: "${VITE_API_BASE_URL}"
    volumes:
      - ./heracles-ui:/app
      - /app/node_modules
    ports:
      - "${UI_PORT:-3000}:3000"
    depends_on:
      - api
    networks:
      - heracles-net
    command: ["bun", "run", "dev", "--host", "0.0.0.0", "--port", "3000"]
    profiles:
      - full

  # ===========================================
  # Heracles UI (React) - Production
  # ===========================================
  ui-prod:
    build:
      context: ./heracles-ui
      dockerfile: Dockerfile
    container_name: heracles-ui-prod
    ports:
      - "80:80"
    depends_on:
      - api
    networks:
      - heracles-net
    profiles:
      - prod

# ===========================================
# Networks
# ===========================================
networks:
  heracles-net:
    driver: bridge

# ===========================================
# Volumes
# ===========================================
volumes:
  ldap_data:
  ldap_config:
  postgres_data:
  redis_data:
